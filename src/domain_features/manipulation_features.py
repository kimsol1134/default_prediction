"""
재무조작 탐지 특성 생성 (15개)

재무조작 탐지: Beneish M-Score 기반 한국형 재무조작 탐지 지표

주요 특성:
- 매출채권회전일수 (DSRI)
- 매출총이익률 (GMI)
- 자산질지수 (AQI)
- 발생액비율
- 감가상각률
- 재고자산회전일수
- 등등 15개 지표

참고: 완전한 M-Score는 전년도 데이터가 필요하므로
      여기서는 당기 데이터만으로 계산 가능한 지표 위주
"""

from typing import Dict
import numpy as np


def create_manipulation_features(financial_data: Dict) -> Dict:
    """
    재무조작 탐지 특성 15개 생성

    Args:
        financial_data: 파싱된 재무제표 딕셔너리

    Returns:
        {
            '매출채권회전일수': 45.0,
            '매출총이익률': 0.35,
            '발생액비율': 0.05,
            ...
        }

    특성 설명:
    - 매출채권회전일수: 매출채권 회수 기간 (정상: < 60일, 위험: > 90일)
    - 매출총이익률: 매출총이익/매출액 (정상: 업종별 상이)
    - 자산질지수: 무형자산/자산 (정상: < 20%, 위험: > 40%)
    - 발생액비율: (당기순이익-OCF)/자산 (정상: < 5%, 위험: > 10%)
    - 감가상각률: 감가상각비/유형자산 (정상: 5-15%, 이상: < 3% 또는 > 20%)
    """
    features = {}

    # 데이터 추출
    매출액 = financial_data.get('매출액', 0)
    매출원가 = financial_data.get('매출원가', 0)
    매출총이익 = financial_data.get('매출총이익', 0)
    매출채권 = financial_data.get('매출채권', 0)
    재고자산 = financial_data.get('재고자산', 0)
    자산총계 = financial_data.get('자산총계', 0)
    유동자산 = financial_data.get('유동자산', 0)
    유형자산 = financial_data.get('유형자산', 0)
    무형자산 = financial_data.get('무형자산', 0)
    당기순이익 = financial_data.get('당기순이익', 0)
    영업활동현금흐름 = financial_data.get('영업활동현금흐름', 0)
    판매비와관리비 = financial_data.get('판매비와관리비', 0)

    # 1. 매출채권회전일수 (Days Sales in Receivables Index)
    # = 매출채권 / (매출액 / 365)
    features['매출채권회전일수'] = 매출채권 / (매출액 / 365 + 1)

    # 2. 매출총이익률 (Gross Margin Index)
    # = (매출액 - 매출원가) / 매출액
    if 매출총이익 > 0:
        features['매출총이익률'] = 매출총이익 / (매출액 + 1)
    else:
        features['매출총이익률'] = (매출액 - 매출원가) / (매출액 + 1)

    # 3. 자산질지수 (Asset Quality Index)
    # = (자산 - 유동자산 - 유형자산) / 자산
    # 무형자산 비중이 높을수록 자산 질이 낮음
    features['자산질지수'] = (
        (자산총계 - 유동자산 - 유형자산) / (자산총계 + 1)
    )

    # 4. 발생액비율 (Accruals to Total Assets)
    # = (당기순이익 - 영업활동현금흐름) / 자산
    발생액 = 당기순이익 - 영업활동현금흐름
    features['발생액비율'] = 발생액 / (자산총계 + 1)

    # 5. 재고자산회전일수
    # = 재고자산 / (매출원가 / 365)
    features['재고자산회전일수'] = 재고자산 / (매출원가 / 365 + 1)

    # 6. 매출채권비율 = 매출채권 / 자산
    features['매출채권비율'] = 매출채권 / (자산총계 + 1)

    # 7. 재고자산비율 = 재고자산 / 자산
    features['재고자산비율'] = 재고자산 / (자산총계 + 1)

    # 8. 무형자산비율 = 무형자산 / 자산
    features['무형자산비율'] = 무형자산 / (자산총계 + 1)

    # 9. 판매비와관리비비율 = 판매비와관리비 / 매출액
    features['판매비와관리비비율'] = 판매비와관리비 / (매출액 + 1)

    # 10. 운전자본회전일수
    # = (매출채권 + 재고자산 - 매입채무) / (매출액 / 365)
    매입채무 = financial_data.get('매입채무', 0)
    운전자본 = 매출채권 + 재고자산 - 매입채무
    features['운전자본회전일수'] = 운전자본 / (매출액 / 365 + 1)

    # 11. 이익의질 = 영업활동현금흐름 / 당기순이익
    # 100% 이상이면 이익이 현금으로 잘 전환
    features['이익의질'] = 영업활동현금흐름 / (당기순이익 + 1)

    # 12. 영업이익률
    영업이익 = financial_data.get('영업이익', 0)
    features['영업이익률'] = 영업이익 / (매출액 + 1)

    # 13. 순이익률
    features['순이익률'] = 당기순이익 / (매출액 + 1)

    # 14. ROA (Return on Assets)
    features['ROA'] = 당기순이익 / (자산총계 + 1)

    # 15. 재무조작위험지수 (복합 지표, 0~1, 높을수록 위험)
    # = 0.2 * 발생액비율_정규화 + 0.2 * 매출채권_정규화 + ...
    발생액_정규화 = max(0, min(1, abs(features['발생액비율']) / 0.1))
    매출채권회전_정규화 = max(0, min(1, features['매출채권회전일수'] / 90))
    이익의질_정규화 = max(0, min(1, 1 - features['이익의질']))

    features['재무조작위험지수'] = (
        0.3 * 발생액_정규화 +
        0.3 * 매출채권회전_정규화 +
        0.4 * 이익의질_정규화
    )

    # 16. 재고회전율 = 매출원가 / 재고자산
    features['재고회전율'] = 매출원가 / (재고자산 + 1)

    # 17. 매출채권회전율 = 매출액 / 매출채권
    features['매출채권회전율'] = 매출액 / (매출채권 + 1)

    # 18. 총발생액 = 당기순이익 - 영업활동현금흐름
    features['총발생액'] = 당기순이익 - 영업활동현금흐름

    # 19. 판관비효율성 = 판매비와관리비 / 매출액 (판매비와관리비비율과 동일하지만 명시적 추가)
    features['판관비효율성'] = 판매비와관리비 / (매출액 + 1)

    # 20. 매출채권_이상지표 = 매출채권비율 * (부채비율/100)
    # 부채비율 계산
    부채총계 = financial_data.get('부채총계', 0)
    자본총계 = financial_data.get('자본총계', 0)
    부채비율 = (부채총계 / (자본총계 + 1)) * 100
    features['매출채권_이상지표'] = features['매출채권비율'] * (부채비율 / 100)

    # 무한대/NaN 처리
    for key in features:
        if not np.isfinite(features[key]):
            features[key] = 0.0

    return features
