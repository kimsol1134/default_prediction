"""
유동성 위기 특성 생성 (10개)

유동성 위기: 단기 지급능력 부족으로 인한 부도 위험

주요 특성:
- 유동비율, 당좌비율, 현금비율
- 현금소진일수 (매우 중요!)
- 운전자본비율
- 긴급유동성비율
- OCF 유동부채 비율
- 현금흐름 적정성
- 유동성위기지수
- 단기지급능력
"""

from typing import Dict
import numpy as np


def create_liquidity_features(financial_data: Dict) -> Dict:
    """
    유동성 위기 특성 10개 생성

    Args:
        financial_data: 파싱된 재무제표 딕셔너리
            {
                '유동자산': 1000,
                '유동부채': 500,
                '현금및현금성자산': 100,
                ...
            }

    Returns:
        {
            '유동비율': 2.0,
            '현금소진일수': 45.0,
            ...
        }

    특성 설명:
    - 유동비율: 단기 지급 능력 (정상: > 100%, 위험: < 100%)
    - 당좌비율: 즉각 지급 능력 (정상: > 100%, 위험: < 80%)
    - 현금비율: 즉시 지급 능력 (정상: > 50%, 위험: < 20%)
    - 현금소진일수: 현금 고갈까지 일수 (정상: > 90일, 위험: < 30일)
    - 운전자본비율: 운전자본의 자산 대비 비율 (정상: > 0%, 위험: < 0%)
    - 긴급유동성비율: 긴급 상황 대응력 (정상: > 30%, 위험: < 10%)
    - OCF유동부채비율: 영업현금흐름의 유동부채 상환 능력 (정상: > 30%, 위험: < 10%)
    - 현금흐름적정성: 이익의 현금화 정도 (정상: > 100%, 위험: < 50%)
    - 유동성위기지수: 종합 유동성 위기 수준 (낮을수록 안전)
    - 단기지급능력: 월평균 지급능력 (정상: > 2, 위험: < 1)
    """
    features = {}

    # 데이터 추출 (기본값 0)
    유동자산 = financial_data.get('유동자산', 0)
    유동부채 = financial_data.get('유동부채', 0)
    현금 = financial_data.get('현금및현금성자산', 0)
    재고자산 = financial_data.get('재고자산', 0)
    단기금융상품 = financial_data.get('단기금융상품', 0)
    자산총계 = financial_data.get('자산총계', 0)
    매출원가 = financial_data.get('매출원가', 0)
    판매비와관리비 = financial_data.get('판매비와관리비', 0)
    영업활동현금흐름 = financial_data.get('영업활동현금흐름', 0)
    당기순이익 = financial_data.get('당기순이익', 0)

    # 1. 유동비율 = 유동자산 / 유동부채
    features['유동비율'] = 유동자산 / (유동부채 + 1)

    # 2. 당좌비율 = (유동자산 - 재고자산) / 유동부채
    당좌자산 = 유동자산 - 재고자산
    features['당좌비율'] = 당좌자산 / (유동부채 + 1)

    # 3. 현금비율 = 현금 / 유동부채
    features['현금비율'] = 현금 / (유동부채 + 1)

    # 4. 현금소진일수 = 현금 / (일평균 영업비용)
    # 일평균 영업비용 = (매출원가 + 판매비와관리비) / 365
    일평균영업비용 = (매출원가 + 판매비와관리비) / 365
    features['현금소진일수'] = 현금 / (일평균영업비용 + 1)

    # 5. 운전자본비율 = (유동자산 - 유동부채) / 자산총계
    운전자본 = 유동자산 - 유동부채
    features['운전자본'] = 운전자본
    features['운전자본비율'] = 운전자본 / (자산총계 + 1)
    features['운전자본_대_자산'] = features['운전자본비율'] # Alias

    # 6. 긴급유동성비율 = (현금 + 단기금융상품) / 유동부채
    features['긴급유동성비율'] = (현금 + 단기금융상품) / (유동부채 + 1)

    # 7. OCF 유동부채 비율 = 영업활동현금흐름 / 유동부채
    features['OCF유동부채비율'] = 영업활동현금흐름 / (유동부채 + 1)

    # 8. 현금흐름 적정성 = 영업활동현금흐름 / 당기순이익
    # 100% 이상이면 이익이 현금으로 잘 전환되고 있음
    features['현금흐름적정성'] = 영업활동현금흐름 / (당기순이익 + 1)

    # 9. 유동성위기지수 (복합 지표, 0~1, 높을수록 위험)
    # = 0.3 * (1 - 유동비율/1.5) + 0.3 * (1 - 현금비율/0.5) + 0.4 * (1 - 현금소진일수/90)
    유동비율_정규화 = max(0, min(1, 1 - features['유동비율'] / 1.5))
    현금비율_정규화 = max(0, min(1, 1 - features['현금비율'] / 0.5))
    현금소진일수_정규화 = max(0, min(1, 1 - features['현금소진일수'] / 90))

    features['유동성위기지수'] = (
        0.3 * 유동비율_정규화 +
        0.3 * 현금비율_정규화 +
        0.4 * 현금소진일수_정규화
    )

    # 10. 단기지급능력 = (현금 + 월평균 영업현금흐름) / (월평균 유동부채)
    월평균OCF = 영업활동현금흐름 / 12
    월평균유동부채 = 유동부채 / 12
    features['단기지급능력'] = (현금 + 월평균OCF) / (월평균유동부채 + 1)

    # 무한대/NaN 처리
    for key in features:
        if not np.isfinite(features[key]):
            features[key] = 0.0

    return features
