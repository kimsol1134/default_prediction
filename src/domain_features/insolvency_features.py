"""
지급불능 특성 생성 (8개)

지급불능: 장기적 채무 상환 능력 부족으로 인한 부도 위험

주요 특성:
- 부채비율, 자본잠식도
- 이자보상배율 (매우 중요!)
- 부채상환년수
- 재무레버리지
- 고정장기적합률
- 순차입금의존도
- 지급불능위험지수
"""

from typing import Dict
import numpy as np


def create_insolvency_features(financial_data: Dict) -> Dict:
    """
    지급불능 특성 8개 생성

    Args:
        financial_data: 파싱된 재무제표 딕셔너리

    Returns:
        {
            '부채비율': 150.0,
            '이자보상배율': 5.0,
            ...
        }

    특성 설명:
    - 부채비율: 부채/자본 비율 (정상: < 200%, 위험: > 300%)
    - 자본잠식도: 자본이 음수인 정도 (정상: 0%, 위험: > 50%)
    - 이자보상배율: 영업이익/이자비용 (정상: > 2, 위험: < 1)
    - 부채상환년수: 부채/영업현금흐름 (정상: < 5년, 위험: > 10년)
    - 재무레버리지: 자산/자본 (정상: < 3, 위험: > 5)
    - 고정장기적합률: 비유동자산/(자본+비유동부채) (정상: < 100%, 위험: > 120%)
    - 순차입금의존도: 순차입금/자산 (정상: < 30%, 위험: > 50%)
    - 지급불능위험지수: 종합 지급불능 위험 (낮을수록 안전)
    """
    features = {}

    # 데이터 추출
    자산총계 = financial_data.get('자산총계', 0)
    부채총계 = financial_data.get('부채총계', 0)
    자본총계 = financial_data.get('자본총계', 0)
    비유동자산 = financial_data.get('비유동자산', 0)
    비유동부채 = financial_data.get('비유동부채', 0)
    영업이익 = financial_data.get('영업이익', 0)
    이자비용 = financial_data.get('이자비용', 0)
    영업활동현금흐름 = financial_data.get('영업활동현금흐름', 0)
    단기차입금 = financial_data.get('단기차입금', 0)
    장기차입금 = financial_data.get('장기차입금', 0)
    현금 = financial_data.get('현금및현금성자산', 0)

    # 1. 부채비율 = (부채 / 자본) * 100
    features['부채비율'] = (부채총계 / (자본총계 + 1)) * 100

    # 2. 자본잠식도 = max(0, -자본) / 자산 * 100
    # 자본이 음수인 경우 (완전자본잠식)
    features['자본잠식도'] = (max(0, -자본총계) / (자산총계 + 1)) * 100

    # 3. 이자보상배율 = 영업이익 / 이자비용
    # 매우 중요! 이자 지급 능력
    features['이자보상배율'] = 영업이익 / (이자비용 + 1)

    # 4. 부채상환년수 = 부채 / 영업활동현금흐름
    # 현재 영업현금흐름으로 부채를 모두 갚는데 걸리는 년수
    features['부채상환년수'] = 부채총계 / (영업활동현금흐름 + 1)

    # 5. 재무레버리지 = 자산 / 자본
    features['재무레버리지'] = 자산총계 / (자본총계 + 1)

    # 6. 고정장기적합률 = 비유동자산 / (자본 + 비유동부채) * 100
    # 장기 안정성 지표 (100% 이하가 바람직)
    features['고정장기적합률'] = (
        비유동자산 / (자본총계 + 비유동부채 + 1)
    ) * 100

    # 7. 순차입금의존도 = 순차입금 / 자산
    순차입금 = 단기차입금 + 장기차입금 - 현금
    features['순차입금의존도'] = 순차입금 / (자산총계 + 1)

    # 8. 지급불능위험지수 (복합 지표, 0~1, 높을수록 위험)
    # = 0.3 * (부채비율/200) + 0.3 * (자본잠식도/50) + 0.4 * (1 - 이자보상배율/2)
    부채비율_정규화 = max(0, min(1, features['부채비율'] / 200))
    자본잠식도_정규화 = max(0, min(1, features['자본잠식도'] / 50))
    이자보상배율_정규화 = max(0, min(1, 1 - features['이자보상배율'] / 2))

    features['지급불능위험지수'] = (
        0.3 * 부채비율_정규화 +
        0.3 * 자본잠식도_정규화 +
        0.4 * 이자보상배율_정규화
    )

    # 9. 순부채비율 = (부채총계 - 현금) / 자본총계 * 100
    # 순차입금의존도와 유사하지만 부채 전체 기준
    features['순부채비율'] = ((부채총계 - 현금) / (자본총계 + 1)) * 100

    # 10. 이자부담률 = 이자비용 / 매출액 * 100
    매출액 = financial_data.get('매출액', 0)
    features['이자부담률'] = (이자비용 / (매출액 + 1)) * 100

    # 무한대/NaN 처리
    for key in features:
        if not np.isfinite(features[key]):
            features[key] = 0.0

    return features
