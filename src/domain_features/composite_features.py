"""
복합 리스크 및 상호작용 특성 생성 (10개)

복합 리스크: 여러 카테고리를 결합한 종합 지표
상호작용: 변수 간 곱셈/제곱 등 비선형 관계
"""

from typing import Dict
import numpy as np


def create_composite_features(all_features: Dict) -> Dict:
    """
    복합 리스크 및 상호작용 특성 10개 생성

    Args:
        all_features: 지금까지 생성한 모든 특성
            (유동성, 지급불능, 재무조작, 한국시장, 이해관계자)

    Returns:
        {
            '종합부도위험스코어': 0.45,
            '조기경보신호수': 3,
            '레버리지_수익성_교차': -0.15,
            ...
        }

    특성 설명:
    - 종합부도위험스코어: 5개 위기지수의 가중평균
    - 조기경보신호수: 임계값 초과한 위험신호 개수
    - 재무건전성지수: 종합 건전성 점수 (높을수록 안전)
    """
    features = {}

    # === 복합 리스크 지표 (7개) ===

    # 1. 종합부도위험스코어 (0~1, 높을수록 위험)
    # = 가중평균(유동성위기지수, 지급불능위험지수, 재무조작위험지수, ...)
    유동성위기 = all_features.get('유동성위기지수', 0)
    지급불능위험 = all_features.get('지급불능위험지수', 0)
    재무조작위험 = all_features.get('재무조작위험지수', 0)
    한국시장리스크 = all_features.get('한국시장리스크지수', 0)
    이해관계자불신 = all_features.get('이해관계자불신지수', 0)

    features['종합부도위험스코어'] = (
        0.25 * 유동성위기 +
        0.25 * 지급불능위험 +
        0.20 * 재무조작위험 +
        0.15 * 한국시장리스크 +
        0.15 * 이해관계자불신
    )

    # 2. 조기경보신호수 (임계값 초과한 위험신호 개수)
    경보신호수 = 0

    # 유동성 경보
    if all_features.get('유동비율', 0) < 1.0:
        경보신호수 += 1
    if all_features.get('현금소진일수', 0) < 30:
        경보신호수 += 1
    if all_features.get('OCF유동부채비율', 0) < 0.2:
        경보신호수 += 1

    # 지급불능 경보
    if all_features.get('이자보상배율', 0) < 1.0:
        경보신호수 += 1
    if all_features.get('부채비율', 0) > 300:
        경보신호수 += 1
    if all_features.get('자본잠식도', 0) > 0:
        경보신호수 += 1

    # 재무조작 경보
    if all_features.get('발생액비율', 0) > 0.1:
        경보신호수 += 1
    if all_features.get('이익의질', 0) < 0.5:
        경보신호수 += 1

    # 이해관계자 경보
    if all_features.get('연체여부', 0) == 1.0:
        경보신호수 += 1
    if all_features.get('세금체납여부', 0) == 1.0:
        경보신호수 += 1

    features['조기경보신호수'] = float(경보신호수)

    # 3. 재무건전성지수 (0~100, 높을수록 안전)
    # = 100 - (종합부도위험스코어 * 100)
    features['재무건전성지수'] = max(0, 100 - features['종합부도위험스코어'] * 100)

    # 4. 단기위험도 (유동성 중심)
    단기위험도 = (
        0.4 * 유동성위기 +
        0.3 * 지급불능위험 +
        0.3 * 이해관계자불신
    )
    features['단기위험도'] = 단기위험도

    # 5. 장기위험도 (지급불능 중심)
    장기위험도 = (
        0.5 * 지급불능위험 +
        0.3 * 재무조작위험 +
        0.2 * 한국시장리스크
    )
    features['장기위험도'] = 장기위험도

    # 6. 회복가능성지수 (낮을수록 회복 어려움)
    # = (영업이익률 + ROA) / 2 - 부채비율/100
    영업이익률 = all_features.get('영업이익률', 0)
    ROA = all_features.get('ROA', 0)
    부채비율 = all_features.get('부채비율', 0)

    회복가능성 = (영업이익률 + ROA) / 2 - 부채비율 / 200
    features['회복가능성지수'] = 회복가능성

    # 7. Z-Score (Altman Z-Score 간소화 버전)
    # = 1.2*운전자본비율 + 1.4*이익잉여금비율 + 3.3*ROA + 0.6*시가총액/부채 + 1.0*자산회전율
    # 시가총액 정보가 없으므로 간소화
    운전자본비율 = all_features.get('운전자본비율', 0)
    features['Altman_Z_Score_간소화'] = (
        1.2 * 운전자본비율 +
        3.3 * ROA +
        0.999 * (1 / (부채비율 / 100 + 1))
    )

    # === 상호작용/비선형 특성 (3개) ===

    # 8. 레버리지×수익성 교차항
    # 레버리지가 높고 수익성이 낮으면 위험
    재무레버리지 = all_features.get('재무레버리지', 0)
    features['레버리지_수익성_교차'] = 재무레버리지 * ROA

    # 9. 부채비율 제곱 (비선형 효과)
    # 부채비율이 높아질수록 위험이 기하급수적으로 증가
    features['부채비율_제곱'] = (부채비율 / 100) ** 2

    # 10. 임계값 기반 특성
    # 이자보상배율 < 1 이면 1, 아니면 0
    이자보상배율 = all_features.get('이자보상배율', 0)
    features['이자지급불능여부'] = 1.0 if 이자보상배율 < 1.0 else 0.0

    # 무한대/NaN 처리
    for key in features:
        if not np.isfinite(features[key]):
            features[key] = 0.0

    return features
